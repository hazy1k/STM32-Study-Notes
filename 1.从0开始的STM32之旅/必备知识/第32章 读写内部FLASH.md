# 第三十二章 读写内部FLASH

## 1. STM32的内部FLASH简介

在STM32芯片内部有一个FLASH存储器，它主要用于存储代码，我们在电脑上编写好应用程序后，使用下载器把编译后的代码文件烧录到该内部FLASH中， 由于FLASH存储器的内容在掉电后不会丢失，芯片重新上电复位后，内核可从内部FLASH中加载代码并运行

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/FLASH002.jpg)

除了使用外部的工具（如下载器）读写内部FLASH外，STM32芯片在运行的时候，也能对自身的内部FLASH进行读写，因此， 若内部FLASH存储了应用程序后还有剩余的空间，我们可以把它像外部SPI-FLASH那样利用起来，存储一些程序运行时产生的需要掉电保存的数据。

由于访问内部FLASH的速度要比外部的SPI-FLASH快得多，所以在紧急状态下常常会使用内部FLASH存储关键记录；为了防止应用程序被抄袭， 有的应用会禁止读写内部FLASH中的内容，或者在第一次运行时计算加密信息并记录到某些区域，然后删除自身的部分加密代码，这些应用都涉及到内部FLASH的操作。

### 1.1 内部FLASH的构成

STM32的内部FLASH包含主存储器、系统存储器以及选项字节区域， 它们的地址分布及大小见表

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/FLASH01.png)

各个存储区域的说明如下：

**主存储**

一般我们说STM32内部FLASH的时候，都是指这个主存储器区域，它是存储用户应用程序的空间， 芯片型号说明中的256K FLASH、512K FLASH都是指这个区域的大小。

主存储器分为256页，每页大小为2KB，共512KB。这个分页的概念，实质就是FLASH存储器的扇区，与其它FLASH一样，在写入数据前，要先按页（扇区）擦除。

注意上表中的主存储器是本实验板使用的STM32VET6型号芯片的参数，即STM32F1大容量产品。若使用超大容量、中容量或小容量产品， 它们主存储器的页数量、页大小均有不同，使用的时候要注意区分。

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/FLASH02.png)

**系统存储区**

系统存储区是用户不能访问的区域，它在芯片出厂时已经固化了启动代码，它负责实现串口、USB以及CAN等ISP烧录功能。

**选项字节**

选项字节用于配置FLASH的读写保护、待机/停机复位、软件/硬件看门狗等功能，这部分共16字节。可以通过修改FLASH的选项控制寄存器修改。

## 2. 对内部FLASH的写入过程

### 2.1 解锁

由于内部FLASH空间主要存储的是应用程序，是非常关键的数据，为了防止误操作修改了这些内容，芯片复位后默认会给控制寄存器FLASH_CR上锁， 这个时候不允许设置FLASH的控制寄存器，从而不能修改FLASH中的内容。

所以对FLASH写入数据前，需要先给它解锁。解锁的操作步骤如下：

1. 往FPEC键寄存器 FLASH_KEYR中写入 KEY1 = 0x45670123

2. 再往FPEC键寄存器 FLASH_KEYR中写入 KEY2 = 0xCDEF89AB

### 2.2 页擦除

在写入新的数据前，需要先擦除存储区域，STM32提供了页（扇区）擦除指令和整个FLASH擦除(批量擦除)的指令，批量擦除指令仅针对主存储区。

页擦除的过程如下：

1. 检查 FLASH_SR 寄存器中的“忙碌寄存器位 BSY”，以确认当前未执行任何 Flash 操作；

2. 在 FLASH_CR 寄存器中，将“激活页擦除寄存器位PER ”置 1，

3. 用FLASH_AR寄存器选择要擦除的页；

4. 将 FLASH_CR 寄存器中的“开始擦除寄存器位 STRT ”置 1，开始擦除；

5. 等待 BSY 位被清零时，表示擦除完成。

### 2.3 写入数据

擦除完毕后即可写入数据，写入数据的过程并不是仅仅使用指针向地址赋值，赋值前还还需要配置一系列的寄存器，步骤如下：

1. 检查 FLASH_SR 中的 BSY 位，以确认当前未执行任何其它的内部 Flash 操作；

2. 将 FLASH_CR 寄存器中的 “激活编程寄存器位PG” 置 1；

3. 向指定的FLASH存储器地址执行数据写入操作，每次只能以16位的方式写入；

4. 等待 BSY 位被清零时，表示写入完成。

## 3. 查看工程的空间分布

由于内部FLASH本身存储有程序数据，若不是有意删除某段程序代码，一般不应修改程序空间的内容， 所以在使用内部FLASH存储其它数据前需要了解哪一些空间已经写入了程序代码，存储了程序代码的扇区都不应作任何修改。 通过查询应用程序编译时产生的“*.map”后缀文件，可以了解程序存储到了哪些区域

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/FLASH003.jpg)

打开map文件后，查看文件最后部分的区域，可以看到一段以“Memory Map of the image”开头的记录(若找不到可用查找功能定位)
