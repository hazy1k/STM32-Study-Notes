# 第二十二章 IWDG-独立看门狗

## 1. IWDG简介

STM32有两个看门狗，一个是独立看门狗另外一个是窗口看门狗，独立看门狗号称宠物狗，窗口看门狗号称警犬，本章我们主要分析独立看门狗的功能框图和它的应用。 独立看门狗用通俗一点的话来解释就是一个12位的递减计数器，当计数器的值从某个值一直减到0的时候，系统就会产生一个复位信号，即IWDG_RESET。 如果在计数没减到0之前，刷新了计数器的值的话，那么就不会产生复位信号，这个动作就是我们经常说的喂狗。看门狗功能由 VDD 电压域供电， 在停止模式和待机模式下仍能工作。

## 2. IWDG功能框图剖析

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/IWDG002.png)

### 2.1 独立看门狗时钟

独立看门狗的时钟由独立的RC振荡器LSI提供，即使主时钟发生故障它仍然有效，非常独立。LSI的频率一般在30~60KHZ之间， 根据温度和工作场合会有一定的漂移，我们一般取40KHZ，所以独立看门狗的定时时间并不一定非常精确，只适用于对时间精度要求比较低的场合。

### 2.2 计数器时钟

递减计数器的时钟由LSI经过一个8位的预分频器得到，我们可以操作预分频器寄存器IWDG_PR来设置分频因子， 分频因子可以是：[4,8,16,32,64,128,256,256]，计数器时钟CK_CNT= 40/ 4*2^PRV，一个计数器时钟计数器就减一。

### 2.3 计数器

独立看门狗的计数器是一个12位的递减计数器，最大值为0XFFF，当计数器减到0时，会产生一个复位信号:IWDG_RESET， 让程序重新启动运行，如果在计数器减到0之前刷新了计数器的值的话，就不会产生复位信号，重新刷新计数器值的这个动作我们俗称喂狗。

### 2.4 重装载寄存器

重装载寄存器是一个12位的寄存器，里面装着要刷新到计数器的值，这个值的大小决定着独立看门狗的溢出时间。 超时时间Tout = (4*2^prv) / 40 * rlv (s) ，prv是预分频器寄存器的值，rlv是重装载寄存器的值。

### 2.5 键寄存器

键寄存器IWDG_KR可以说是独立看门狗的一个控制寄存器，主要有三种控制方式，往这个寄存器写入下面三个不同的值有不同的效果。

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/IWDG01.png)

通过写往键寄存器写0XCCC来启动看门狗是属于软件启动的方式，一旦独立看门狗启动，它就关不掉，只有复位才能关掉。

### 2.6 状态寄存器

状态寄存器SR只有位0：PVU和位1：RVU有效，这两位只能由硬件操作，软件操作不了。RVU：看门狗计数器重装载值更新， 硬件置1表示重装载值的更新正在进行中，更新完毕之后由硬件清0。PVU:看门狗预分频值更新，硬件置’1’指示预分频值的更新正在进行中， 当更新完成后，由硬件清0。所以只有当RVU/PVU等于0的时候才可以更新重装载寄存器/预分频寄存器。

### 3. IWDG的作用

独立看门狗一般用来检测和解决由程序引起的故障，比如一个程序正常运行的时间是50ms， 在运行完这个段程序之后紧接着进行喂狗，我们设置独立看门狗的定时溢出时间为60ms，比我们需要监控的程序50ms多一点， 如果超过60ms还没有喂狗，那就说明我们监控的程序出故障了，跑飞了，那么就会产生系统复位，让程序重新运行。


