# 第二十三章 WWDG-窗口看门狗

## 1. WWDG简介

STM32有两个看门狗，一个是独立看门狗，一个是窗口看门狗。我们知道独立看门狗的工作原理就是一个递减计数器不断的往下递减计数， 当减到0之前如果没有喂狗的话，产生复位。窗口看门狗跟独立看门狗一样，也是一个递减计数器不断的往下递减计数， 当减到一个固定值0X40时还不喂狗的话，产生复位，这个值叫窗口的下限，是固定的值，不能改变。这个是跟独立看门狗类似的地方， 不同的地方是窗口看门狗的计数器的值在减到某一个数之前喂狗的话也会产生复位，这个值叫窗口的上限，上限值由用户独立设置。 窗口看门狗计数器的值必须在上窗口和下窗口之间才可以喂狗，这就是窗口看门狗中窗口两个字的含义

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/WWDG002.png)

RLR是重装载寄存器，用来设置独立看门狗的计数器的值。TR是窗口看门狗的计数器的值，由用户独立设置，WR是窗口看门狗的上窗口值，由用户独立设置。

## 2. WWDG功能框图剖析

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/WWDG003.png)

### 2.1 窗口看门狗时钟

窗口看门狗时钟来自PCLK1，PCLK1最大是36M，由RCC时钟控制器开启。

### 2.2 计数器时钟

计数器时钟由CK计时器时钟经过预分频器分频得到，分频系数由配置寄存器CFR的位8:7  WDGTB[1:0]配置，可以是[0,1,2,3]， 其中CK计时器时钟=PCLK1/4096，除以4096是手册规定的，没有为什么。所以计数器的时钟CNT_CK=PCLK1/4096/(2^WDGTB)， 这就可以算出计数器减一个数的时间T= 1/CNT_CK = Tpclk1 * 4096 * (2^WDGTB)。

### 2.3 计数器

窗口看门狗的计数器是一个递减计数器，共有7位，其值存在控制寄存器CR的位6:0，即T[6:0]，当7个位全部为1时是0X7F， 这个是最大值，当递减到T6位变成0时，即从0X40变为0X3F时候，会产生看门狗复位。这个值0X40是看门狗能够递减到的最小值， 所以计数器的值只能是：0X40~0X7F之间，实际上真正用来计数的是T[5:0]。当递减计数器递减到0X40的时候，还不会马上产生复位， 如果使能了提前唤醒中断：CFR位9EWI置1，则产生提前唤醒中断，如果真进入了这个中断的话，就说明程序肯定是出问题了， 那么在中断服务程序里面我们就需要做最重要的工作，比如保存重要数据，或者报警等，这个中断我们也叫它死前中断。

### 2.4 窗口值

我们知道窗口看门狗必须在计数器的值在一个范围内才可以喂狗，其中下窗口的值是固定的0X40，上窗口的值可以改变， 具体的由配置寄存器CFR的位6:0 W[6:0]设置。其值必须大于0X40，如果小于或者等于0X40就是失去了窗口的价值，而且也不能大于计数器的值， 所以必须得小于0X7F。那窗口值具体要设置成多大？这个得根据我们需要监控的程序的运行时间来决定。如果我们要监控的程序段A运行的时间为Ta， 当执行完这段程序之后就要进行喂狗，如果在窗口时间内没有喂狗的话，那程序就肯定是出问题了。一般计数器的值TR设置成最大0X7F，窗口值为WR， 计数器减一个数的时间为T，那么时间：(TR-WR)*T应该稍微小于Ta即可，这样就能做到刚执行完程序段A之后喂狗，起到监控的作用，这样也就可以算出WR的值是多少。

### 2.5 计算看门狗超时时间

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/WWDG004.png)

这个图来自数据手册，从图我们知道看门狗超时时间：Twwdg = Tpclk1 x 4096 x 2^wdgtb x (T[5:0] + 1) ms， 当PCLK1 = 36MHZ时，WDGTB取不同的值时有最小和最大的超时时间，那这个最小和最大的超时时间该怎么理解，又是怎么算出来的？ 讲起来有点绕，这里我稍微讲解下WDGTB=0时是怎么算的。递减计数器有7位T[6:0] ，当位6变为0的时候就会产生复位，实际上有效的计数位是T[5:0]， 而且T6必须先设置为1。如果T[5:0]=0时，递减计数器再减一次，就产生复位了， 那这减一的时间就等于计数器的周期=1/CNT_CK = Tpclk1 * 4096 * (2^WDGTB) = 1/36 * 4096 *2^0 =113.7us， 这个就是最短的超时时间。如果T[5:0]全部装满为1，即63，当他减到0X40变成0X3F时，所需的时间就是最大的超时时间=113.7*2^5=113.7*64=7.2768ms。 同理，当WDGTB等于1/2/3时，代入公式即可。

## 3. WWDG的作用

WWDG一般被用来监测，由外部干扰或不可预见的逻辑条件造成的应用程序背离正常的运行序列而产生的软件故障。比如一个程序段正常运行的时间是50ms， 在运行完这个段程序之后紧接着进行喂狗，如果在规定的时间窗口内还没有喂狗，那就说明我们监控的程序出故障了，跑飞了，那么就会产生系统复位，让程序重新运行。

## 4. 独立看门狗与窗口看门狗之比较

独立看门狗（IWDG）和窗口看门狗（WWDG）在功能和使用场景上有明显区别：

1. **工作原理**：
   
   - **IWDG**：定期重装载计数器，如果未在设定时间内重装载，系统会复位。适合简单应用。
   - **WWDG**：在设定的时间窗口内必须重装载，如果重装载在窗口外进行，系统也会复位。适合需要更高实时性的应用。

2. **使用灵活性**：
   
   - **IWDG**：仅需周期性重装载。
   - **WWDG**：需要在严格的时间窗口内操作，增加了开发复杂性。

3. **复位机制**：
   
   - **IWDG**：超时后立即复位。
   - **WWDG**：可以选择在窗口内不重装载而产生复位，增加了灵活性。

---

2024.9.19 第一次修订，后期不再维护
