# 第四十九章 液晶显示中英文（字库在外部FLASH)

## 1. 硬件设计

针对不同模式的液晶显示字符工程，需要有不同的硬件支持。字库存储在STM32芯片内部FLASH的工程跟普通液晶显示的硬件需求无异。 需要外部字库的工程，要有额外的SPI-FLASH、SD支持，使用外部FLASH时，我们的实验板上直接用板子上的SPI-FLASH芯片存储字库， 出厂前我们已给FLASH芯片烧录了前面的《GB2312_H1616.FON》字库文件，如果想把我们的程序移植到自己设计产品上， 请确保该系统包含有存储了字库的FLASH芯片，才能正常显示汉字。使用SD卡时，需要给板子接入存储有《GB2312_H1616.FON》字库文件的MicroSD卡， SD卡的文件系统格式需要是FAT格式，且字库文件所在的目录需要跟程序里使用的文件目录一致。

关于SPI-FLASH和SD卡的原理图及驱动说明可参考其他的章节。给外部SPI-FLASH和SD卡存储字库的操作我们将在另一个文档中说明

## 2. 软件设计

### 2.1 编程目标

1. 获取字模数据；

2. 根据字模格式，编写液晶显示函数；

3. 编写测试程序，控制液晶英文。

### 2.2 代码分析

- ASCII字模数据

要显示字符首先要有字库数据， 在工程的“fonts.c”文件中我们定义了一系列大小为24x32、16x24、8x16的ASCII码表的字模数据：

```c
/*
* 常用ASCII表，偏移量32，大小:24（高度）* 16 （宽度）
*/
//@conslons字体，阴码点阵格式，逐行顺向取摸
const uint8_t ASCII16x24_Table [ ] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x80,0x01,0x80,0x01,0x80,
    0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
    0x01,0x80,0x01,0x80,0x01,0x80,0x00,0x00,
    0x00,0x00,0x03,0xc0,0x03,0xc0,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    /*以下部分省略.....，包含从 空格 至 波浪号 的ASCII码图形字模数据*/
```

由于ASCII中的字符并不多，所以本工程中直接以C语言数组的方式存储这些字模数据，C语言的const数组是作为常量直接存储到STM32芯片的内部FLASH中的， 所以如果不需要显示中文，可以不用外部的SPI-FLASH芯片，可省去烧录字库的麻烦。以上代码定义的ASCII16x24_Table数组是16x24大小的ASCII字库。

- 管理英文字模的结构体

为了方便使用各种不同的字体，工程中定义了一个“sFont”结构体类型，并利用它定义存储了不同字体信息的结构体变量：

```c
/*字体格式*/
typedef struct _tFont {
    const uint8_t *table; /*指向字模数据的指针*/
    uint16_t Width;   /*字模的像素宽度*/
    uint16_t Height;    /*字模的像素高度*/

} sFONT;

sFONT Font8x16 = {
    ASCII8x16_Table,
    8, /* 字模宽 */
    16, /* 字模高 */
};

sFONT Font16x24 = {
    ASCII16x24_Table,
    16, /* 字模宽 */
    24, /* 字模高 */
};

sFONT Font24x32 = {
    ASCII24x32_Table,
    24, /* 字模宽 */
    32, /* 字模高 */
};
```

这个结构体类型定义了三个变量，第一个是指向字模数据的指针，即前面提到的C语言数组，每二、三个变量存储了该字模单个字符的像素宽度和高度。 利用这个类型定义了Font8x16、Font16x24之类的变量，方便显示时寻址。


