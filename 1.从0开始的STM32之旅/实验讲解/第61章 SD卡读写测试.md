# 第六十一章 SD卡读写测试

## 1. 硬件设计

STM32控制器的SDIO引脚是被设计固定不变的，开发板设计采用四根数据线模式。对于命令线和数据线须需要加一个上拉电阻。

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/SDIO019.png)

## 2. 软件设计

### 2.1 前提须知

际上，SD卡是非常常用外设部件，ST公司在其测试板上也有板子SD卡卡槽， 并提供了完整的驱动程序，我们直接参考移植使用即可。类似SDIO、USB这些复杂的外设，它们的通信协议相当庞大，要自行编写完整、 严谨的驱动不是一件轻松的事情，这时我们就可以利用ST官方例程的驱动文件，根据自己硬件移植到自己开发平台即可。

在“初识STM32标准库”章节我们重点讲解了标准库的源代码及启动文件和库使用帮助文档这两部分内容，实际上“Utilities”文件夹内容是非常有参考价值的， 该文件夹包含了基于ST官方实验板的驱动文件，比如LCD、SRAM、SD卡、音频解码IC等等底层驱动程序， 另外还有第三方软件库，如emWin图像软件库和FatFs文件系统。虽然，我们的开发平台跟ST官方实验平台硬件设计略有差别，但移植程序方法是完全可行的。 学会移植程序可以减少很多工作量，加快项目进程，更何况ST官方的驱动代码是经过严格验证的。

在ST固件库“STM32F10x_StdPeriph_Lib_V3.5.0UtilitiesSTM32_EVALCommon”文件夹下可以找到SD卡驱动文件，我们需要stm32_eval_sdio_sd.c和stm32_eval_sdio_sd.h两个文件的完整内容。 另外还可以参考目录“STM32F10x_StdPeriph_Lib_V3.5.0ProjectSTM32F10x_StdPeriph_ExamplesSDIOuSDCard”下中的示例代码编写测试， 为简化工程，本章配置工程代码是将这些与SD卡相关的的内容都添加到stm32_eval_sdio_sd.c文件中，具体可以参考工程文件。

![](https://doc.embedfire.com/mcu/stm32/f103zhinanzhe/std/zh/latest/_images/SDIO020.png)

我们把stm32_eval_sdio_sd.c和stm32_eval_sdio_sd.h两个文件拷贝到我们的工程文件夹中，另外，添加的sdio_test.c和sdio_test.h文件包含了SD卡读、写、擦除测试代码。

### 2.2 编程大纲

1. 初始化相关GPIO及SDIO外设

2. 配置SDIO基本通信环境进入卡识别模式，通过几个命令处理后得到卡类型

3. 如果是可用卡就进入数据传输模式，接下来就可以进行读、写、擦除的操作

4. 主函数测试

### 2.3 代码分析


